-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.intervention_protocols (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  category text NOT NULL CHECK (category = ANY (ARRAY['preventive'::text, 'self_help'::text, 'peer_support'::text, 'professional'::text, 'crisis'::text])),
  priority integer DEFAULT 0,
  is_active boolean DEFAULT true,
  triggers jsonb NOT NULL,
  action_type text NOT NULL,
  action_payload jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT intervention_protocols_pkey PRIMARY KEY (id)
);
CREATE TABLE public.interventions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  status text CHECK (status = ANY (ARRAY['monitoring'::text, 'under_review'::text, 'escalated'::text, 'resolved'::text])),
  assigned_by text,
  notes text,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT interventions_pkey PRIMARY KEY (id),
  CONSTRAINT interventions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.journals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  content text NOT NULL,
  entry_date date NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT journals_pkey PRIMARY KEY (id),
  CONSTRAINT journals_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.mood_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  mood_score integer CHECK (mood_score >= 1 AND mood_score <= 10),
  entry_date date NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT mood_logs_pkey PRIMARY KEY (id),
  CONSTRAINT mood_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  industry text,
  company_code text NOT NULL UNIQUE,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT organizations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  full_name text NOT NULL,
  age integer,
  gender text,
  affiliation_type text CHECK (affiliation_type = ANY (ARRAY['student'::text, 'employee'::text, 'individual'::text, 'community'::text])),
  affiliation_name text,
  external_identifier text,
  created_at timestamp without time zone DEFAULT now(),
  last_checkin timestamp without time zone,
  organization_id uuid,
  team_id uuid,
  role text DEFAULT 'USER'::text,
  CONSTRAINT profiles_pkey PRIMARY KEY (id),
  CONSTRAINT profiles_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT profiles_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id)
);
CREATE TABLE public.sentiment_analysis (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  journal_id uuid,
  sentiment_score numeric,
  emotion_label text,
  created_at timestamp without time zone DEFAULT now(),
  sentiment_text text,
  CONSTRAINT sentiment_analysis_pkey PRIMARY KEY (id),
  CONSTRAINT sentiment_analysis_journal_id_fkey FOREIGN KEY (journal_id) REFERENCES public.journals(id)
);
CREATE TABLE public.session_participants (
  id integer NOT NULL DEFAULT nextval('session_participants_id_seq'::regclass),
  session_id integer NOT NULL,
  employee_id uuid,
  team_id uuid,
  CONSTRAINT session_participants_pkey PRIMARY KEY (id),
  CONSTRAINT session_participants_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.sessions(id),
  CONSTRAINT session_participants_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.profiles(id),
  CONSTRAINT session_participants_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id)
);
CREATE TABLE public.sessions (
  id integer NOT NULL DEFAULT nextval('sessions_id_seq'::regclass),
  title text NOT NULL,
  description text,
  session_type text NOT NULL CHECK (session_type = ANY (ARRAY['INDIVIDUAL'::text, 'TEAM'::text, 'ORGANIZATION'::text])),
  scheduled_at timestamp without time zone NOT NULL,
  status text NOT NULL DEFAULT 'SCHEDULED'::text CHECK (status = ANY (ARRAY['SCHEDULED'::text, 'COMPLETED'::text, 'CANCELLED'::text])),
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT sessions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.severity_assessments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  week_start_date date NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  phq9_total integer CHECK (phq9_total >= 0 AND phq9_total <= 27),
  gad7_total integer CHECK (gad7_total >= 0 AND gad7_total <= 21),
  q9_score integer CHECK (q9_score >= 0 AND q9_score <= 3),
  tier integer NOT NULL CHECK (tier >= 0 AND tier <= 4),
  primary_domain text CHECK (primary_domain = ANY (ARRAY['depression'::text, 'anxiety'::text, 'mixed'::text])),
  safety_flag boolean DEFAULT false,
  reassessment_interval_days integer DEFAULT 7,
  clinician_recommendation text CHECK (clinician_recommendation = ANY (ARRAY['none'::text, 'suggested'::text, 'strong'::text])),
  monitoring_intensity text CHECK (monitoring_intensity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])),
  behavioral_activation_index numeric,
  sleep_disturbance_index numeric,
  catastrophizing_index numeric,
  rumination_index numeric,
  weeks_in_tier integer DEFAULT 1,
  previous_tier integer,
  escalation_flag boolean DEFAULT false,
  step_down_flag boolean DEFAULT false,
  CONSTRAINT severity_assessments_pkey PRIMARY KEY (id),
  CONSTRAINT severity_assessments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.sleep_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  sleep_hours numeric,
  sleep_quality integer CHECK (sleep_quality >= 1 AND sleep_quality <= 10),
  entry_date date NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT sleep_logs_pkey PRIMARY KEY (id),
  CONSTRAINT sleep_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.stress_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  stress_level integer CHECK (stress_level >= 1 AND stress_level <= 10),
  trigger text,
  entry_date date NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT stress_logs_pkey PRIMARY KEY (id),
  CONSTRAINT stress_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.teams (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  organization_id uuid,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT teams_pkey PRIMARY KEY (id),
  CONSTRAINT teams_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.therapist_assignments (
  id integer NOT NULL DEFAULT nextval('therapist_assignments_id_seq'::regclass),
  session_id integer NOT NULL,
  therapist_id integer NOT NULL,
  employee_id uuid,
  CONSTRAINT therapist_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT therapist_assignments_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.sessions(id),
  CONSTRAINT therapist_assignments_therapist_id_fkey FOREIGN KEY (therapist_id) REFERENCES public.therapists(id),
  CONSTRAINT therapist_assignments_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.therapists (
  id integer NOT NULL DEFAULT nextval('therapists_id_seq'::regclass),
  name text NOT NULL,
  specialization text,
  email text NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT therapists_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_interventions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  week_start_date date NOT NULL,
  protocol_id uuid,
  severity_assessment_id uuid,
  intervention_text text NOT NULL,
  severity text CHECK (severity = ANY (ARRAY['crisis'::text, 'high'::text, 'medium'::text, 'low'::text, 'info'::text])),
  action_type text NOT NULL,
  action_payload jsonb,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'viewed'::text, 'acted'::text, 'dismissed'::text])),
  viewed_at timestamp with time zone,
  acted_at timestamp with time zone,
  dismissed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_interventions_pkey PRIMARY KEY (id),
  CONSTRAINT user_interventions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id),
  CONSTRAINT user_interventions_protocol_id_fkey FOREIGN KEY (protocol_id) REFERENCES public.intervention_protocols(id),
  CONSTRAINT user_interventions_severity_assessment_id_fkey FOREIGN KEY (severity_assessment_id) REFERENCES public.severity_assessments(id)
);
CREATE TABLE public.user_risk_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  risk_score numeric,
  recorded_at date DEFAULT CURRENT_DATE,
  CONSTRAINT user_risk_history_pkey PRIMARY KEY (id),
  CONSTRAINT user_risk_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);
CREATE TABLE public.wellbeing_scores (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  mood_avg numeric,
  stress_avg numeric,
  sleep_avg numeric,
  sentiment_avg numeric,
  composite_score numeric,
  risk_level text CHECK (risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  calculated_at timestamp without time zone DEFAULT now(),
  phq9_score integer,
  gad7_score integer,
  CONSTRAINT wellbeing_scores_pkey PRIMARY KEY (id),
  CONSTRAINT wellbeing_scores_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.profiles(id)
);